# Reusable Stale Issues/PRs workflow
# Marks issues stale after 90d, rotten after 15d more, closed after 15d more
# Marks PRs stale after 21d, rotten after 7d more, closed after 7d more
#
# Usage in consuming repo:
#   name: Mark Stale Issues
#   on:
#     schedule:
#       - cron: '0 1 * * *'
#   jobs:
#     stale:
#       uses: llm-d/llm-d-infra/.github/workflows/reusable-stale.yml@main
#       permissions:
#         issues: write
#         pull-requests: write

name: Stale Issues (Reusable)

on:
  workflow_call:
    inputs:
      days-before-issue-stale:
        description: 'Days before marking issues stale'
        required: false
        type: number
        default: 90
      days-before-pr-stale:
        description: 'Days before marking PRs stale'
        required: false
        type: number
        default: 21

permissions:
  issues: write
  pull-requests: write

jobs:
  stale-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Mark stale issues and PRs
        uses: actions/stale@v10
        with:
          days-before-issue-stale: ${{ inputs.days-before-issue-stale }}
          days-before-pr-stale: ${{ inputs.days-before-pr-stale }}
          days-before-close: -1
          stale-issue-label: 'lifecycle/stale'
          exempt-issue-labels: 'lifecycle/rotten'
          stale-issue-message: >-
            This issue is marked as stale after ${{ inputs.days-before-issue-stale }}d of inactivity.
            After an additional 30d of inactivity (15d to become rotten, then 15d more), it will be closed.
            To prevent this issue from being closed, add a comment or remove the `lifecycle/stale` label.
          stale-pr-label: 'lifecycle/stale'
          exempt-pr-labels: 'lifecycle/rotten'
          stale-pr-message: >-
            This PR is marked as stale after ${{ inputs.days-before-pr-stale }}d of inactivity.
            After an additional 14d of inactivity (7d to become rotten, then 7d more), it will be closed.
            To prevent this PR from being closed, add a comment or remove the `lifecycle/stale` label.

      - name: Mark items rotten
        uses: actions/stale@v10
        with:
          days-before-issue-stale: 15
          days-before-pr-stale: 7
          days-before-close: -1
          stale-issue-label: 'lifecycle/rotten'
          stale-pr-label: 'lifecycle/rotten'
          only-labels: 'lifecycle/stale'
          labels-to-remove-when-stale: 'lifecycle/stale'

      - name: Close rotten items
        uses: actions/stale@v10
        with:
          days-before-stale: -1
          days-before-issue-close: 15
          days-before-pr-close: 7
          stale-issue-label: 'lifecycle/rotten'
          stale-issue-message: 'This issue is being closed after extended inactivity.'
          stale-pr-label: 'lifecycle/rotten'
          stale-pr-message: 'This PR is being closed after extended inactivity.'
