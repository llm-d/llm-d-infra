name: Docker Build and Push
description: Build and push multi-arch container image to ghcr.io

inputs:
  image-name:
    required: true
    description: Image name (e.g., my-project)
  tag:
    required: true
    description: Image tag (e.g., v0.1.0)
  github-token:
    required: true
    description: GitHub token for ghcr.io login
  registry:
    required: false
    description: Container registry
    default: ghcr.io/llm-d
  platforms:
    required: false
    description: Target platforms
    default: linux/amd64,linux/arm64
  prerelease:
    required: false
    description: If true, skip tagging as 'latest'
    default: "false"

runs:
  using: "composite"
  steps:
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      run: echo "${{ inputs.github-token }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      shell: bash

    - name: Build and push image
      run: |
        if [[ "${{ inputs.prerelease }}" == "true" ]]; then
          LATEST_TAG=""
        else
          LATEST_TAG="-t ${{ inputs.registry }}/${{ inputs.image-name }}:latest"
        fi
        docker buildx build \
          --platform ${{ inputs.platforms }} \
          --push \
          --annotation "index:org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
          --annotation "index:org.opencontainers.image.licenses=Apache-2.0" \
          -t ${{ inputs.registry }}/${{ inputs.image-name }}:${{ inputs.tag }} \
          ${LATEST_TAG} .
      shell: bash
